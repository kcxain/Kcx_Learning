<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-system/CSAPP/Lab04-Architecture_Lab">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Lab4-Architecture Lab 深入解析 | CS-Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://deconx.cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://deconx.cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://deconx.cn/system/CSAPP/Lab04-Architecture_Lab"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab4-Architecture Lab 深入解析 | CS-Notes"><meta data-rh="true" name="description" content="穷且益坚，不坠青云之志。"><meta data-rh="true" property="og:description" content="穷且益坚，不坠青云之志。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://deconx.cn/system/CSAPP/Lab04-Architecture_Lab"><link data-rh="true" rel="alternate" href="https://deconx.cn/system/CSAPP/Lab04-Architecture_Lab" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://deconx.cn/system/CSAPP/Lab04-Architecture_Lab" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CS-Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CS-Notes Atom Feed">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a22b4ae4.css">
<link rel="preload" href="/assets/js/runtime~main.a0c4db13.js" as="script">
<link rel="preload" href="/assets/js/main.0632a7d6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CS-Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/system">计算机基础</a><a class="navbar__item navbar__link" href="/ai">人工智能</a><a class="navbar__item navbar__link" href="/code-daily">算法刷题</a><a class="navbar__item navbar__link" href="/project">动手造轮子</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kcxain" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">首页</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/ai">人工智能</a><button aria-label="打开/收起侧边栏菜单「人工智能」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/code-daily">算法刷题</a><button aria-label="打开/收起侧边栏菜单「算法刷题」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/project">动手造轮子</a><button aria-label="打开/收起侧边栏菜单「动手造轮子」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/system">计算机基础</a><button aria-label="打开/收起侧边栏菜单「计算机基础」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/system/CSAPP">CSAPP 实验解析</a><button aria-label="打开/收起侧边栏菜单「CSAPP 实验解析」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab01-Data_Lab">Lab1-Data Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab02-Bomb_Lab">Lab2-Bomb Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab03-Attack_Lab">Lab3-Attack Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/system/CSAPP/Lab04-Architecture_Lab">Lab4-Architecture Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab05-Cache_Lab">Lab5-Cache Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab06-Performance_Lab">Lab6-Performance Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab07-Shell_Lab">Lab7-Shell Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab08-Malloc_Lab">Lab8-Malloc Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/Lab09-Proxy_Lab">Lab9-Proxy Lab 深入解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/system/CSAPP/gdb常用命令">gdb 常用命令</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/system/Computer-Network">计算机网络</a><button aria-label="打开/收起侧边栏菜单「计算机网络」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/system/MIT6S081">MIT-6.s081 实验解析</a><button aria-label="打开/收起侧边栏菜单「MIT-6.s081 实验解析」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/system/Software-Construction">软件构造</a><button aria-label="打开/收起侧边栏菜单「软件构造」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/system"><span itemprop="name">计算机基础</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/system/CSAPP"><span itemprop="name">CSAPP 实验解析</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab4-Architecture Lab 深入解析</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Lab4-Architecture Lab 深入解析</h1><blockquote><p>穷且益坚，不坠青云之志。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="实验概览">实验概览<a href="#实验概览" class="hash-link" aria-label="实验概览的直接链接" title="实验概览的直接链接">​</a></h2><p>Arch Lab 实验分为三部分。在 A 部分中，需要我们写一些简单的<code>Y86-64</code>程序，从而熟悉<code>Y86-64</code>工具的使用；在 B 部分中，我们要用一个新的指令来扩展<code>SEQ</code>；C 部分是本实验的核心，我们要通过理解流水线的过程以及利用新的指令来优化程序。</p><p>实验材料中有一个<code>archlab.pdf</code>，按照文档一步步往下走就可以了。<code>make</code>时，可能会缺少相关依赖，安装如下软件即可</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> tcl tcl-dev tk tk-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> flex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> bison</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-a">Part A<a href="#part-a" class="hash-link" aria-label="Part A的直接链接" title="Part A的直接链接">​</a></h2><p>在这部分，要用<code>Y86-64</code>汇编代码实现<code>examples.c</code>中的三个函数。这三个函数都是与链表有关的操作，链表结点定义如下</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* linked list element */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ELE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ELE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">list_ptr</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在编写汇编代码之前，我们先回顾一下<code>Y86-64</code>的指令集：</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># movq i--&gt;r: 从立即数到寄存器...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">irmovq, rrmovq, mrmovq, rmmovq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Opq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addq, subq, andq, xorq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 跳转 jXX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jmp, jle, jl, je, jne, jge, jg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 条件传送 cmovXX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmovle, cmovl, cmove, cmovne, cmovge, cmovg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call, ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushq, popq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止指令的执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">halt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%rax, %rcx, %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%rbx, %rsp, %rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%rsi, %rdi, %r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%r9, %r10, %r11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%r12, %r13, %r14</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sum_list">sum_list<a href="#sum_list" class="hash-link" aria-label="sum_list的直接链接" title="sum_list的直接链接">​</a></h3><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* sum_list - Sum the elements of a linked list */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sum_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list_ptr ls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>本题就是一个链表求和，非常简单。但要注意，这里不仅要写出函数段，还应该写出测试的代码段。直接给出转换后的汇编代码：</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># sum_list - Sum the elements of a linked list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># author: Deconx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Execution begins at address 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pos 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq stack, %rsp      # Set up stack pointer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call main               # Execute main program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        halt                    # Terminate program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Sample linked list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .align 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ele1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x00a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad ele2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ele2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x0b0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad ele3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ele3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0xc00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq ele1,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call sum_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># long sum_list(list_ptr ls)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># start in %rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sum_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq $0, %rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmp test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mrmovq (%rdi), %rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addq %rsi, %rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mrmovq 8(%rdi), %rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        andq %rdi, %rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jne loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Stack starts here and grows to lower addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pos 0x200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意，应在<code>stack</code>下方空一行，否则汇编器会报错，报错原因我也不清楚。</p><p>利用实验文件中给的<code>YAS</code>汇编器进行汇编，<code>YIS</code>指令集模拟器运行<strong>测试</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./yas sum.ys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./yis sum.yo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>得到结果</p><p><img loading="lazy" src="/assets/images/image-20220312124402451-2297dd4a2889bf8b0e932f633341b750.png" width="961" height="269" class="img_ev3q"></p><p>返回值<code>%rax=0xcba=0x00a+0x0b0+0xc00</code>，<strong>结果正确！</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rsum_list">rsum_list<a href="#rsum_list" class="hash-link" aria-label="rsum_list的直接链接" title="rsum_list的直接链接">​</a></h3><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* rsum_list - Recursive version of sum_list */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rsum_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list_ptr ls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> rest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rsum_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ls</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rest</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是链表求和的递归实现，按照C语言代码的过程模拟即可，思路非常清晰，可以参考我的注释</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># /* rsum_list - Recursive version of sum_list */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># author: Deconx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Execution begins at address 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pos 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq stack, %rsp      # Set up stack pointer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call main               # Execute main program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        halt                    # Terminate program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Sample linked list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .align 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ele1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x00a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad ele2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ele2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x0b0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad ele3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ele3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0xc00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq ele1,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call rsum_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># long sum_list(list_ptr ls)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># start in %rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rsum_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        andq %rdi, %rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        je return               # if(!ls)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mrmovq (%rdi), %rbx     # val = ls-&gt;val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mrmovq 8(%rdi), %rdi    # ls = ls-&gt;next</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pushq %rbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call rsum_list          # rsum_list(ls-&gt;next)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        popq %rbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addq %rbx, %rax         # val + rest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq $0, %rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Stack starts here and grows to lower addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pos 0x200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>测试</strong></p><p><img loading="lazy" src="/assets/images/image-20220312143805214-0f681086664442e8afb0d08ddeadde4c.png" width="951" height="461" class="img_ev3q"></p><p><strong>结果正确！</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="copy_block">copy_block<a href="#copy_block" class="hash-link" aria-label="copy_block的直接链接" title="copy_block的直接链接">​</a></h3><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* copy_block - Copy src to dest and return xor checksum of src */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">copy_block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">src</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dest</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        len</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>数组赋值操作，返回值为原数组各项的按位异或</p><p>这段代码的架构与书上<strong>图 4-7</strong>的例子完全相同，包括常数的处理，循环的设置技巧，退出循环的判断... 照猫画虎即可，当然，我也在后面附上了注释</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* copy_block - Copy src to dest and return xor checksum of src */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># author: Deconx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Execution begins at address 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pos 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq stack, %rsp      # Set up stack pointer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call main               # Execute main program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        halt                    # Terminate program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Sample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .align 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Source block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x00a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x0b0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0xc00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Destination block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dest:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x222</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .quad 0x333</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq src, %rdi        # src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq dest, %rsi       # dest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq $3, %rdx         # len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        call copy_block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># long copy_block(long *src, long *dest, long len)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># src in %rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># dest in %rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># len in %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">copy_block:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq $8, %r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq $1, %r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        irmovq $0, %rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        andq %rdx, %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmp test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mrmovq (%rdi), %r10     # val = *src1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addq %r8, %rdi          # src++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rmmovq %r10, (%rsi)     # *dest = val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addq %r8, %rsi          # dest++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xorq %r10, %rax         # result ^= val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        subq %r9, %rdx          # len--.  Set CC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jne loop                # Stop when 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Stack starts here and grows to lower addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .pos 0x200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>编译运行一下</p><p><img loading="lazy" src="/assets/images/image-20220312155107577-3a73bc3843c031138d93382ed4b143d2.png" width="960" height="482" class="img_ev3q"></p><p><strong>结果完全正确</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-b">Part B<a href="#part-b" class="hash-link" aria-label="Part B的直接链接" title="Part B的直接链接">​</a></h2><p>Part B 整合了第 4 章的 homework - 4.51, 4.52。就是实现<code>iaddq</code>指令，将立即数与寄存器相加。可以参考<code>irmovq</code>和<code>OPq</code>指令的计算。在开始之前，我们还是先回顾一下处理一条指令的各个阶段吧！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="回顾指令处理框架">回顾：指令处理框架<a href="#回顾指令处理框架" class="hash-link" aria-label="回顾：指令处理框架的直接链接" title="回顾：指令处理框架的直接链接">​</a></h3><ul><li><strong>取址：</strong>根据 PC 的值从内存中读取指令字节<ul><li>指令指示符字节的两个四位部分，为<code>icode:ifun</code></li><li>寄存器指示符字节，为 <code>rA</code>, <code>rB</code></li><li>8字节常数字，为 <code>valC</code></li><li>计算下一条指令地址，为 <code>valP</code></li></ul></li><li><strong>译码：</strong>从寄存器读入最多两个操作数<ul><li>由 <code>rA</code>, <code>rB</code> 指明的寄存器，读为 <code>valA</code>, <code>valB</code></li><li>对于指令<code>popq</code>, <code>pushq</code>, <code>call</code>, <code>ret</code>也可能从<code>%rsp</code>中读</li></ul></li><li><strong>执行：</strong>根据<code>ifun</code>计算，或计算内存引用的有效地址，或增加或减少栈指针<ul><li>对上述三者之一进行的操作得到的值为<code>valE</code></li><li>如果是计算，则设置条件码</li><li>对于条件传送指令，检验条件码和传送条件，并据此更新目标寄存器</li><li>对于跳转指令，决定是否选择分支</li></ul></li><li><strong>访存：</strong>顾名思义<ul><li>可能是将数据写入内存</li><li>若是从内存中读出数据，则读出的值为<code>valM</code></li></ul></li><li><strong>写回：</strong>最多写两个结果到寄存器</li><li><strong>更新 PC：</strong>将 PC 设置成下一条指令的地址</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="iaddq指令执行过程"><code>iaddq</code>指令执行过程<a href="#iaddq指令执行过程" class="hash-link" aria-label="iaddq指令执行过程的直接链接" title="iaddq指令执行过程的直接链接">​</a></h3><p><code>iaddq</code>的执行与<code>Opq</code>非常相似，后者需要取出<code>rA</code>与<code>rB</code>分别指示的寄存器进行运算后再写回<code>rB</code>指示的寄存器。而前者与后者唯一的区别就是，不需要从<code>rA</code>中取数，直接立即数计算即可。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">指令为：iaddq V</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">取指：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">ifun </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> M_1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">PC</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rA</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">rB </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> M_1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">PC</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valC </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> M_8</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">PC</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valP </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> PC</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">译码：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valB </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rB</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valE </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">  valB </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> valC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set CC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">访存：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">写回：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    R</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rB</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> valE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">更新PC：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PC </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> valP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="修改hcl代码">修改<code>HCL</code>代码<a href="#修改hcl代码" class="hash-link" aria-label="修改hcl代码的直接链接" title="修改hcl代码的直接链接">​</a></h3><p>接下来要在<code>seq-full.hcl</code>文件中修改代码。由于<code>iaddq</code>的操作与<code>OPq</code>和<code>irmovq</code>类似，比较取巧的做法是，搜索有这两个指令的描述块进行修改即可。本着学习的目的，我们分阶段对所有信号逐个分析</p><p><strong>取指阶段</strong></p><p><code>instr_valid</code>：判断指令是否合法，当然应该加上。修改后为</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bool instr_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> icode in </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> INOP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IHALT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRMMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IMRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           IOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IJXX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICALL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPUSHQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>need_regids</code>：判断指令是否包括寄存器指示符字节，当然也应该加上</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bool need_regids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IRRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPUSHQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             IIRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRMMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IMRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>need_valC</code>：判断指令是否包括常数字，还是要加上</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bool need_valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IIRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRMMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IMRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IJXX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICALL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>译码和写回阶段</strong></p><p><code>srcB</code>：赋为产生<code>valB</code>的寄存器。译码阶段要从<code>rA</code>, <code>rB</code> 指明的寄存器读为 <code>valA</code>, <code>valB</code>，而<code>iaddq</code>有一个<code>rB</code>，于是有以下修改</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">word srcB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRMMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IMRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rB</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IPUSHQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICALL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRET </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RRSP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RNONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  # Don&#x27;t need </span><span class="token keyword" style="color:#00009f">register</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>dst_E</code>：表明写端口 E 的目的寄存器，计算出来的值<code>valE</code>将放在那里。最终结果要存放在<code>rB</code>中，所以要修改</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">word dstE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IRRMOVQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> Cnd </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rB</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IIRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rB</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IPUSHQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICALL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRET </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RRSP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RNONE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  # Don&#x27;t write any </span><span class="token keyword" style="color:#00009f">register</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>执行阶段</strong></p><p>执行阶段<code>ALU</code>要对<code>aluA</code>和<code>aluB</code>进行计算，计算格式为：<code>aluB OP aluA</code>。所以<code>aluaA</code>可以是<code>valA</code>和<code>valC</code>或者<code>+-8</code>，<code>aluaB</code>只能是<code>valB</code>。而<code>iaddq</code>执行阶段进行的运算是<code>valB + valC</code>，于是可知修改</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Select input A to ALU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">word aluA </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IRRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IOPQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> valA</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IIRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRMMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IMRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> valC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> ICALL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPUSHQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IRET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPOPQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">Other instructions don&#x27;t need ALU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Select input B to ALU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">word aluB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IRMMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IMRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ICALL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              IPUSHQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IRET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> valB</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IRRMOVQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIRMOVQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">Other instructions don&#x27;t need ALU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>set_cc</code>：判断是否应该更新条件码寄存器，这里应该加上</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bool set_cc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> icode in </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> IOPQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IIADDQ </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>访存阶段</strong></p><p><code>iaddq</code>没有访存阶段，无需修改</p><p><strong>更新PC阶段</strong></p><p><code>iaddq</code>不涉及转移等操作，也无需修改</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试seq">测试<code>SEQ</code><a href="#测试seq" class="hash-link" aria-label="测试seq的直接链接" title="测试seq的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="编译失败处理办法">编译失败处理办法<a href="#编译失败处理办法" class="hash-link" aria-label="编译失败处理办法的直接链接" title="编译失败处理办法的直接链接">​</a></h4><p>编译<code>ssim</code>的时候出现了很多问题：</p><p><img loading="lazy" src="/assets/images/image-20220312222140881-93a03307055be97607206eb96ef054bd.png" width="961" height="276" class="img_ev3q"></p><p>提示不存在<code>tk.h</code>这个头文件，这是由于实验文件太老。把<code>Makefile</code>修改一下。第 20 行改为</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">TKINC</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-isystem /usr/include/tcl8.6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第 26 行改为</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CFLAGS</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Wall </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">O2 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">DUSE_INTERP_RESULT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是接下来还是报错了</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ld: /tmp/ccKTMI04.o:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">.data.rel+0x0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: undefined reference to `matherr&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collect2: error: ld returned </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">exit</span><span class="token plain"> status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make: *** </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Makefile:44: ssim</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Error </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是因为较新版本<code>glibc</code>弃用了这部分内容</p><p>解决办法是注释掉<code> /sim/pipe/psim.c 806、807 line</code>和<code> /sim/seq/ssim.c 844、845 line</code>。即：有源代码中有<code>matherr</code>的一行和它的下一行</p><p>接下来就能编译成功了！虽然会有很多 Warning</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a href="#测试" class="hash-link" aria-label="测试的直接链接" title="测试的直接链接">​</a></h4><p><strong>第一轮测试</strong></p><p>运行一个简单的<code>Y86-64</code> 程序，并将结果<code>ISA</code>模拟器的结果进行比对，输出如下</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ./ssim -t </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/y86-code/asumi.yo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Y86-64 Processor: seq-full.hcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">137</span><span class="token plain"> bytes of code </span><span class="token builtin class-name">read</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched irmovq at 0x0.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsp, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched call at 0xa.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wrote 0x13 to address 0xf8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched irmovq at 0x38.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched irmovq at 0x42.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched call at 0x4c.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wrote 0x55 to address 0xf0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched xorq at 0x56.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rax, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rax, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched andq at 0x58.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched jmp at 0x5a.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x83</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched jne at 0x83.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched mrmovq at 0x63.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched addq at 0x6d.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rax, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x6f.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x79.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0xffffffffffffffff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched jne at 0x83.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched mrmovq at 0x63.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched addq at 0x6d.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rax, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x6f.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x79.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0xffffffffffffffff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched jne at 0x83.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched mrmovq at 0x63.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched addq at 0x6d.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rax, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x6f.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x79.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0xffffffffffffffff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched jne at 0x83.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched mrmovq at 0x63.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched addq at 0x6d.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%r10, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rax, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x6f.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rdi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched iaddq at 0x79.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">%rsi, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0xffffffffffffffff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched jne at 0x83.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched ret at 0x8c.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched ret at 0x55.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF: Fetched </span><span class="token function" style="color:#d73a49">halt</span><span class="token plain"> at 0x13.  </span><span class="token assign-left variable" style="color:#36acaa">ra</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, </span><span class="token assign-left variable" style="color:#36acaa">rb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">----, valC </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> instructions executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HLT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Condition Codes: </span><span class="token assign-left variable" style="color:#36acaa">Z</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">S</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">O</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Changed Register State:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%rax:   0x0000000000000000      0x0000abcdabcdabcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%rsp:   0x0000000000000000      0x0000000000000100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%rdi:   0x0000000000000000      0x0000000000000038</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%r10:   0x0000000000000000      0x0000a000a000a000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Changed Memory State:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00f0: 0x0000000000000000      0x0000000000000055</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00f8: 0x0000000000000000      0x0000000000000013</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ISA Check Succeeds</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>成功！</p><p><strong>标准测试</strong></p><p>运行一个标准检查程序</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/y86-code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> testssim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t asum.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> asum.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t asumr.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> asumr.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t cjr.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cjr.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t j-cc.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> j-cc.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t poptest.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> poptest.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t pushquestion.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> pushquestion.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t pushtest.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> pushtest.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog1.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog1.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog2.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog2.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog3.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog3.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog4.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog4.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog5.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog5.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog6.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog6.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog7.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog7.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t prog8.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> prog8.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/seq/ssim -t ret-hazard.yo </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ret-hazard.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ISA Check&quot;</span><span class="token plain"> *.seq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">asum.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">asumr.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cjr.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">j-cc.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">poptest.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog1.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog2.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog3.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog4.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog5.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog6.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog7.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prog8.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushquestion.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushtest.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret-hazard.seq:ISA Check Succeeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> asum.seq asumr.seq cjr.seq j-cc.seq poptest.seq pushquestion.seq pushtest.seq prog1.seq prog2.seq prog3.seq prog4.seq prog5.seq prog6.seq prog7.seq prog8.seq ret-hazard.seq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>全部都是 Succeeds</p><p><strong>回归测试</strong></p><p>测试除<code>iaddq</code>的所有指令</p><p><img loading="lazy" src="/assets/images/image-20220312224855040-2cd63da6ebf68e285218f21dbc030ad8.png" width="920" height="353" class="img_ev3q"></p><p>专门测试<code>iaddq</code>指令</p><p><img loading="lazy" src="/assets/images/image-20220312225008116-f24460e95fa60f13866e8dca583393ba.png" width="907" height="356" class="img_ev3q"></p><p>于是，我们就通过了实验材料中的所有测试用例！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-c">Part C<a href="#part-c" class="hash-link" aria-label="Part C的直接链接" title="Part C的直接链接">​</a></h2><p>Part C 在<code>sim/pipe</code>中进行。PIPE 是使用了转发技术的流水线化的<code>Y86-64</code>处理器。它相比 Part B 增加了流水线寄存器和流水线控制逻辑。</p><p>在本部分中，我们要通过修改<code>pipe-full.hcl</code>和<code>ncopy.ys</code>来优化程序，通过程序的效率，也就是 CPE 来计算我们的分数，分数由下述公式算出</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><mo separator="true">,</mo><mi>c</mi><mo>&gt;</mo><mn>10.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>20</mn><mo>⋅</mo><mrow><mo fence="true">(</mo><mn>10.5</mn><mo>−</mo><mi>c</mi><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mn>7.50</mn><mo>⩽</mo><mi>c</mi><mo>⩽</mo><mn>10.50</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>60</mn><mo separator="true">,</mo><mi>c</mi><mo>&lt;</mo><mn>7.50</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">S=\begin{cases} 0, c&gt;10.5\\ 20\cdot \left( 10.5-c \right) , 7.50\leqslant c\leqslant 10.50\\ 60, c&lt;7.50\\ \end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em"><span style="top:-2.2em"><span class="pstrut" style="height:3.15em"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em"><span class="pstrut" style="height:3.15em"></span><span style="height:0.316em;width:0.8889em"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"></path></svg></span></span><span style="top:-3.15em"><span class="pstrut" style="height:3.15em"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em"><span class="pstrut" style="height:3.15em"></span><span style="height:0.316em;width:0.8889em"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"></path></svg></span></span><span style="top:-4.6em"><span class="pstrut" style="height:3.15em"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em"><span style="top:-4.41em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">10.5</span></span></span><span style="top:-2.97em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord">20</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">(</span><span class="mord">10.5</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">c</span><span class="mclose delimcenter" style="top:0em">)</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">7.50</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">10.50</span></span></span><span style="top:-1.53em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord">60</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">7.50</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div><p>首先，<code>iaddq</code>是一个非常好的指令，它可以把两步简化为一步，所以我们先修改<code>pipe-full.hcl</code>，增加<code>iaddq</code>指令，修改参考 Part B 即可。稳妥起见，修改后还是应该测试一下这个模拟器，<code>Makefile</code>参考 Part B 部分进行同样的修改后编译。然后执行以下命令进行测试：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./psim -t </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/y86-code/asumi.yo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ptest</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">SIM</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/pipe/psim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ptest</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">SIM</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/pipe/psim </span><span class="token assign-left variable" style="color:#36acaa">TFLAGS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-i</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当所有测试都显示 Succeed 后，就可以真正开始本部分的重头戏了！</p><p><code>ncopy</code>函数将一个长度为<code>len</code>的整型数组<code>src</code>复制到一个不重叠的数组<code>dst</code>，并返回<code>src</code>中正数的个数。C 语言代码如下</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * ncopy - copy src to dst, returning number of positive ints</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * contained in src array.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">word_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ncopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">word_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">word_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">word_t</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">word_t</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">word_t</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">src</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dst</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    len</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>原汇编代码如下：</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># You can modify this portion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Loop header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xorq %rax,%rax      # count = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %rdx,%rdx      # len &lt;= 0?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Done        # if so, goto Done:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop:   mrmovq (%rdi), %r10 # read val from src...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r10, (%rsi) # ...and store it to dst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r10, %r10     # val &lt;= 0?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Npos        # if so, goto Npos:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    irmovq $1, %r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addq %r10, %rax     # count++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Npos:   irmovq $1, %r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subq %r10, %rdx     # len--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    irmovq $8, %r10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addq %r10, %rdi     # src++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addq %r10, %rsi     # dst++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %rdx,%rdx      # len &gt; 0?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jg Loop         # if so, goto Loop:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>先分别执行以下命令，对原始代码测试一波 CPE</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./correctness.pl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./benchmark.pl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>得</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Average CPE     </span><span class="token number" style="color:#36acaa">15.18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Score   </span><span class="token number" style="color:#36acaa">0.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用iaddq"><strong>利用<code>iaddq</code></strong><a href="#利用iaddq" class="hash-link" aria-label="利用iaddq的直接链接" title="利用iaddq的直接链接">​</a></h3><p>首先能够直观看到，为了<code>len--/src++/dst++</code>等操作，对<code>%rdi</code>进行了不少次赋值操作，这些都可以用我们新增的<code>iaddq</code>指令替代。</p><p>替代后代码为</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">You can modify this portion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">Loop header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xorq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax      # count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx      # len </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Done        # </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> so</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> Done</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r10 # read val from src</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> # </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">and store it to dst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r10     # val </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Npos        # </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> so</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> Npos</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax      # count</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Npos</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx     # len</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi      # src</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi      # dst</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx      # len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jg Loop         # </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> so</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> Loop</span><span class="token operator" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试 CPE</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Average CPE     </span><span class="token number" style="color:#36acaa">12.70</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Score   </span><span class="token number" style="color:#36acaa">0.0</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>虽然分数还是0，但已经有了不少提升</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="循环展开">循环展开<a href="#循环展开" class="hash-link" aria-label="循环展开的直接链接" title="循环展开的直接链接">​</a></h3><p>根据文档的提示，可以试试循环展开进行优化。 循环展开通过增加每次迭代计算的元素的数量，减少循环的迭代次数。这样做对效率提升有什么作用呢？</p><ul><li>减少了索引计算的次数</li><li>减少了条件分支的判断次数</li></ul><p>那么展开几路效率最高呢？我从5路展开开始分别进行了测试</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">5</span><span class="token plain">路：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Average CPE     </span><span class="token number" style="color:#36acaa">9.61</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Score   </span><span class="token number" style="color:#36acaa">17.8</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">路：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Average CPE     </span><span class="token number" style="color:#36acaa">9.58</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Score   </span><span class="token number" style="color:#36acaa">18.3</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">7</span><span class="token plain">路：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Average CPE     </span><span class="token number" style="color:#36acaa">9.59</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Score   </span><span class="token number" style="color:#36acaa">18.2</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">8</span><span class="token plain">路：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Average CPE     </span><span class="token number" style="color:#36acaa">9.62</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Score   </span><span class="token number" style="color:#36acaa">17.5</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以，我选择进行6路展开</p><div class="language-assem codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assem codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    # Loop header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %rdx,%rdx      # len &lt;= 0?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq (%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq 8(%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,8(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq 16(%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,16(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq 24(%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,24(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq 32(%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,32(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop5:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq 40(%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,40(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $48,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $48,%rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $-6, %rdx         # 先减，判断够不够6个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jge Loop                # 6路展开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $-8,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $-8,%rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $6, %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp test2               #剩下的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lore:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq (%rdi),%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq %r8,(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq %r8,%r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle test2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $1,%rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $8,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $8,%rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $-1, %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jge Lore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>代码逻辑非常简单：每次循环都对6个数进行复制，每次复制就设置一个条件语句判断返回时是否加1，对于剩下的数据每次循环只对1个数进行复制。</p><p>为了方便分析，我把极端的几个例子的情况列下来：</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        ncopy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0       26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1       35      35.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2       47      23.50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3       56      18.67</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4       68      17.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5       77      15.40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6       69      11.50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7       78      11.14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8       90      11.25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9       99      11.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10      111     11.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11      120     10.91</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12      112     9.33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13      121     9.31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14      133     9.50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15      142     9.47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16      154     9.62</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17      163     9.59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18      155     8.61</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">50      391     7.82</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">51      400     7.84</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">52      412     7.92</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">53      421     7.94</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">54      413     7.65</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55      422     7.67</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">56      434     7.75</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">57      443     7.77</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">58      455     7.84</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">59      464     7.86</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">60      456     7.60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">61      465     7.62</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">62      477     7.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">63      486     7.71</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64      498     7.78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average CPE     9.58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Score   18.3/60.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>观察上表，对于小数据而言， CPE 的值非常大，后续可以考虑对小数据进行优化。我们先优化剩余数据的处理，对他们继续进行循环展开。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="剩余数据处理">剩余数据处理<a href="#剩余数据处理" class="hash-link" aria-label="剩余数据处理的直接链接" title="剩余数据处理的直接链接">​</a></h3><p>对于剩余数据，我选择3路循环展开。前面的6路与上面代码一样，我就不再贴出来了</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">Loop header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx      # len </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop1</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop4</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop5</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx         # 先减，判断够不够</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jge Loop                # </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">路展开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp test2               #剩下的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle L1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle L2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle test2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx         # 先减，判断够不够</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jge L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx          # </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">则不剩了，直接Done</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 剩一个</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">剩</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    je R0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jl Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle R2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意对于3路展开的特殊处理。看第38、39行，通过直接判断剩余数据的数量减少一次条件判断</p><p>CPE 值为</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Average CPE     </span><span class="token number" style="color:#36acaa">9.07</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Score   </span><span class="token number" style="color:#36acaa">28.5</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>提升了很多，但是依然连一般的分数都还没拿到...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="消除气泡">消除气泡<a href="#消除气泡" class="hash-link" aria-label="消除气泡的直接链接" title="消除气泡的直接链接">​</a></h3><p>注意，程序多次使用了下面的操作：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Y86-64</code>处理器的流水线有 F(取指)、D(译码)、E(执行)、M(访存)、W(写回) 五个阶段，D 阶段才读取寄存器，M 阶段才读取对应内存值，</p><p>即使使用转发来避免数据冒险，这其中也至少会有一个气泡。像这样</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bubble</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一个优化办法是，多取一个寄存器，连续进行两次数据复制。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrmovq </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>像这样，对<code>%r8</code>和<code>%r9</code>进行读入和读出的操作之间都隔着一条其他指令，就不会有气泡产生了。代码如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">Loop header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx      # len </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">40</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">40</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Loop5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loop5</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx         # 先减，判断够不够</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jge Loop                # </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">路展开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp test2               #剩下的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle L1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle L2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle test2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx         # 先减，判断够不够</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jge L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdx          # </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">则不剩了，直接Done</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 剩一个</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">剩</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    je R0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jl Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrmovq </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle R2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mrmovq</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    andq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmmovq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">r8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jle Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iaddq $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意，只有<code>rmmovq</code>不改变条件寄存器的值，所以我们也可以把<code>andq</code>插进中间来消除气泡。</p><p>CPE 值为</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Average CPE     </span><span class="token number" style="color:#36acaa">8.16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Score   </span><span class="token number" style="color:#36acaa">46.9</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">60.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这一步的提升是巨大的！我的分数终于像点样子了！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="进一步优化">进一步优化<a href="#进一步优化" class="hash-link" aria-label="进一步优化的直接链接" title="进一步优化的直接链接">​</a></h3><p>这里先留个坑。</p><p>暂且截图记录我<strong>目前</strong>为止的最高成就：</p><p>运行正确：</p><p><img loading="lazy" src="/assets/images/image-20220313213326792-944f06a2888791cc7affa428ea6947f0.png" width="985" height="547" class="img_ev3q"></p><p>分数为：46.8</p><p><img loading="lazy" src="/assets/images/image-20220313213349365-cf15d0cf477e58bee197466d8c67d94c.png" width="985" height="547" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><ul><li>读 CSAPP 第 4 章时，我理解得很不通透，部分内容甚至有些迷糊。而做完了本实验，通过亲自设计指令，亲自模拟流水线的工作过程并思考如何优化，我对处理器体系结构有了更深的感悟，有一种了然于胸的感觉。</li><li>CMU 的这两位大神老师 Randal E. Bryant 和 David R. O&#x27;Hallaron 简直令我佩服得五体投地。我本以为他们只是从理论层面上将第 4 章的处理器指令，流水线如何设计等等教授给我们。没想到，他们竟然真正设计实现了这样一套完整的<code>Y86-64</code>模拟器、测试工具供我们学习。本实验尤其是 Part C 每优化一次就能立即看到自己的分数，这犹如游戏闯关一般的体验令我着迷。这一切要归功于两位老师细致的设计，希望有生之年能见他们一次！</li><li>作为一个完美主义者，我在 Part C 部分却没有拿到满分，这简直是无法忍受的。但是我着实学业繁忙，不能在这个实验耗费太多时间，只能暂且搁置，暑假回来继续干它！</li><li>本实验耗时 3 天，约 17 小时</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kcxain/kcxain.github.io/tree/master/docs/system/CSAPP/Lab04-Architecture_Lab.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/system/CSAPP/Lab03-Attack_Lab"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Lab3-Attack Lab 深入解析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/system/CSAPP/Lab05-Cache_Lab"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Lab5-Cache Lab 深入解析</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#实验概览" class="table-of-contents__link toc-highlight">实验概览</a></li><li><a href="#part-a" class="table-of-contents__link toc-highlight">Part A</a><ul><li><a href="#sum_list" class="table-of-contents__link toc-highlight">sum_list</a></li><li><a href="#rsum_list" class="table-of-contents__link toc-highlight">rsum_list</a></li><li><a href="#copy_block" class="table-of-contents__link toc-highlight">copy_block</a></li></ul></li><li><a href="#part-b" class="table-of-contents__link toc-highlight">Part B</a><ul><li><a href="#回顾指令处理框架" class="table-of-contents__link toc-highlight">回顾：指令处理框架</a></li><li><a href="#iaddq指令执行过程" class="table-of-contents__link toc-highlight"><code>iaddq</code>指令执行过程</a></li><li><a href="#修改hcl代码" class="table-of-contents__link toc-highlight">修改<code>HCL</code>代码</a></li><li><a href="#测试seq" class="table-of-contents__link toc-highlight">测试<code>SEQ</code></a></li></ul></li><li><a href="#part-c" class="table-of-contents__link toc-highlight">Part C</a><ul><li><a href="#利用iaddq" class="table-of-contents__link toc-highlight"><strong>利用<code>iaddq</code></strong></a></li><li><a href="#循环展开" class="table-of-contents__link toc-highlight">循环展开</a></li><li><a href="#剩余数据处理" class="table-of-contents__link toc-highlight">剩余数据处理</a></li><li><a href="#消除气泡" class="table-of-contents__link toc-highlight">消除气泡</a></li><li><a href="#进一步优化" class="table-of-contents__link toc-highlight">进一步优化</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">联系我</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kcxain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.zhihu.com/people/deconx" target="_blank" rel="noopener noreferrer" class="footer__link-item">知乎<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/kecxain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 CS-Notes, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a0c4db13.js"></script>
<script src="/assets/js/main.0632a7d6.js"></script>
</body>
</html>