"use strict";(self.webpackChunkcs_notes=self.webpackChunkcs_notes||[]).push([[7323],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>k});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),o=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=o(e.components);return a.createElement(p.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=o(t),m=r,k=u["".concat(p,".").concat(m)]||u[m]||d[m]||i;return t?a.createElement(k,l(l({ref:n},c),{},{components:t})):a.createElement(k,l({ref:n},c))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=m;var s={};for(var p in n)hasOwnProperty.call(n,p)&&(s[p]=n[p]);s.originalType=e,s[u]="string"==typeof e?e:r,l[1]=s;for(var o=2;o<i;o++)l[o]=t[o];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},40173:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>o});var a=t(87462),r=(t(67294),t(3905));const i={},l="Lab9-Proxy Lab \u6df1\u5165\u89e3\u6790",s={unversionedId:"system/CSAPP/Lab09-Proxy_Lab",id:"system/CSAPP/Lab09-Proxy_Lab",title:"Lab9-Proxy Lab \u6df1\u5165\u89e3\u6790",description:"\u5b9e\u9a8c\u6982\u89c8",source:"@site/docs/system/CSAPP/Lab09-Proxy_Lab.md",sourceDirName:"system/CSAPP",slug:"/system/CSAPP/Lab09-Proxy_Lab",permalink:"/CS-Notes/system/CSAPP/Lab09-Proxy_Lab",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/system/CSAPP/Lab09-Proxy_Lab.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Lab8-Malloc Lab \u6df1\u5165\u89e3\u6790",permalink:"/CS-Notes/system/CSAPP/Lab08-Malloc_Lab"},next:{title:"gdb \u5e38\u7528\u547d\u4ee4",permalink:"/CS-Notes/system/CSAPP/gdb\u5e38\u7528\u547d\u4ee4"}},p={},o=[{value:"\u5b9e\u9a8c\u6982\u89c8",id:"\u5b9e\u9a8c\u6982\u89c8",level:2},{value:"TINY Web \u670d\u52a1\u5668\u8be6\u89e3",id:"tiny-web-\u670d\u52a1\u5668\u8be6\u89e3",level:2},{value:"\u89e3\u6790 HTTP \u8bf7\u6c42",id:"\u89e3\u6790-http-\u8bf7\u6c42",level:3},{value:"\u63d0\u4f9b\u9759\u6001\u5185\u5bb9",id:"\u63d0\u4f9b\u9759\u6001\u5185\u5bb9",level:3},{value:"\u63d0\u4f9b\u52a8\u6001\u5185\u5bb9",id:"\u63d0\u4f9b\u52a8\u6001\u5185\u5bb9",level:3},{value:"\u4e3b\u51fd\u6570",id:"\u4e3b\u51fd\u6570",level:3},{value:"Part 1: Implementing A sequential web proxy",id:"part-1-implementing-a-sequential-web-proxy",level:2},{value:"\u7b49\u5f85\u5ba2\u6237\u7aef\u8fde\u63a5",id:"\u7b49\u5f85\u5ba2\u6237\u7aef\u8fde\u63a5",level:3},{value:"\u8f6c\u53d1\u4e0e\u56de\u590d",id:"\u8f6c\u53d1\u4e0e\u56de\u590d",level:3},{value:"\u89e3\u6790uri",id:"\u89e3\u6790uri",level:3},{value:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c",id:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c",level:3},{value:"Part 2: Dealing with multiple concurrent requests",id:"part-2-dealing-with-multiple-concurrent-requests",level:2},{value:"\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b",id:"\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b",level:3},{value:"\u57fa\u4e8e\u9884\u7ebf\u7a0b\u5316\u7684 Proxy",id:"\u57fa\u4e8e\u9884\u7ebf\u7a0b\u5316\u7684-proxy",level:3},{value:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c",id:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c-1",level:3},{value:"Part 3: Caching web objects",id:"part-3-caching-web-objects",level:2},{value:"\u8bfb\u8005-\u5199\u8005\u6a21\u578b",id:"\u8bfb\u8005-\u5199\u8005\u6a21\u578b",level:3},{value:"Cache \u7ed3\u6784",id:"cache-\u7ed3\u6784",level:3},{value:"\u4ee3\u7801",id:"\u4ee3\u7801",level:3},{value:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c",id:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c-2",level:3},{value:"FireFox \u5b9e\u6218\u6d4b\u8bd5",id:"firefox-\u5b9e\u6218\u6d4b\u8bd5",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2},{value:"\u5199\u5728\u6700\u540e",id:"\u5199\u5728\u6700\u540e",level:2}],c={toc:o},u="wrapper";function d(e){let{components:n,...i}=e;return(0,r.kt)(u,(0,a.Z)({},c,i,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"lab9-proxy-lab-\u6df1\u5165\u89e3\u6790"},"Lab9-Proxy Lab \u6df1\u5165\u89e3\u6790"),(0,r.kt)("h2",{id:"\u5b9e\u9a8c\u6982\u89c8"},"\u5b9e\u9a8c\u6982\u89c8"),(0,r.kt)("p",null,"Web Proxy \u662f Web \u6d4f\u89c8\u5668\u548c\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u4e00\u4e2a\u4e2d\u95f4\u7a0b\u5e8f\u3002\u6211\u4eec\u65e5\u5e38\u4f7f\u7528\u6d4f\u89c8\u5668\u8bbf\u95ee\u67d0\u4e2a\u7f51\u7ad9\u65f6\uff0c\u6d4f\u89c8\u5668\u4e0d\u662f\u76f4\u63a5\u8bf7\u6c42\u670d\u52a1\u5668\u6765\u83b7\u53d6\u5185\u5bb9\u7684\uff0c\u800c\u662f\u8054\u7cfb Proxy\uff0cProxy \u8f6c\u53d1\u8bf7\u6c42\u5230\u670d\u52a1\u5668\uff0c\u670d\u52a1\u5668\u56de\u590d Proxy \u540e\uff0cProxy \u518d\u5c06\u56de\u590d\u53d1\u9001\u5230\u6d4f\u89c8\u5668\u3002"),(0,r.kt)("p",null,"\u5373\u539f\u6765\u7684\u5ba2\u6237\u7aef-\u670d\u52a1\u5668\u662f\u8fd9\u6837\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(27991).Z,width:"1460",height:"304"})),(0,r.kt)("p",null,"\u52a0\u4e86 Proxy \u53d8\u6210\u8fd9\u6837"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(6284).Z,width:"1523",height:"326"})),(0,r.kt)("p",null,"\u672c\u5b9e\u9a8c\u5c31\u662f\u8981\u5b9e\u73b0\u4e00\u4e2a\u652f\u6301",(0,r.kt)("strong",{parentName:"p"},"\u591a\u7ebf\u7a0b\u5e26\u7f13\u5b58"),"\u7684 Web \u4ee3\u7406\uff0c\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\u6765\u8fdb\u884c\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Part 1"),"\uff1a\u5b9e\u73b0\u4e00\u4e2a\u6700\u57fa\u7840\u7684\u987a\u5e8f\u4ee3\u7406"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Part 2"),"\uff1a\u8fdb\u4e00\u6b65\u4f18\u5316\uff0c\u4f7f\u4ee3\u7406\u652f\u6301\u591a\u7ebf\u7a0b\uff08\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b\uff09"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Part 3"),"\uff1a\u4f7f\u7528 LRU \u7b56\u7565\u7f13\u5b58 Web \u4e2d\u7684\u5bf9\u8c61\uff08\u8bfb\u8005-\u5199\u8005\u6a21\u578b\uff09")),(0,r.kt)("h2",{id:"tiny-web-\u670d\u52a1\u5668\u8be6\u89e3"},"TINY Web \u670d\u52a1\u5668\u8be6\u89e3"),(0,r.kt)("p",null,"\u4ee3\u7406\u76f8\u5bf9\u4e8e\u5ba2\u6237\u7aef\u6765\u8bf4\u5145\u5f53\u4e86\u670d\u52a1\u7aef\u7684\u89d2\u8272\uff0c\u76f8\u5bf9\u4e8e\u670d\u52a1\u7aef\u6765\u8bf4\u53c8\u5145\u5f53\u4e86\u5ba2\u6237\u7aef\u7684\u89d2\u8272\uff0c\u6240\u4ee5\u53ef\u4ee5\u5927\u91cf\u5229\u7528\u4e66\u4e2d\u8bb2\u89e3\u670d\u52a1\u5668\u7684\u4ee3\u7801\u3002"),(0,r.kt)("p",null,"CSAPP \u8bfe\u672c\u7528 250 \u884c\u4ee3\u7801\u4e3a\u6211\u4eec\u5b9e\u73b0\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684 Web \u670d\u52a1\u5668\uff0c\u5728\u505a\u5b9e\u9a8c\u4e4b\u524d\uff0c\u6df1\u523b\u7406\u89e3\u5b83\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002"),(0,r.kt)("p",null,"\u9996\u5148\u8981\u505a\u7684\u4e8b\u5c31\u662f\u89e3\u6790 HTTP \u8bf7\u6c42"),(0,r.kt)("h3",{id:"\u89e3\u6790-http-\u8bf7\u6c42"},"\u89e3\u6790 HTTP \u8bf7\u6c42"),(0,r.kt)("p",null,"HTTP \u8bf7\u6c42\u7684\u7ec4\u6210\u662f\u8fd9\u6837\u7684\uff1a\u4e00\u4e2a\u8bf7\u6c42\u884c\uff0c\u540e\u9762\u8ddf\u968f\u96f6\u4e2a\u6216\u66f4\u591a\u4e2a\u8bf7\u6c42\u62a5\u5934\uff0c\u5728\u8ddf\u968f\u4e00\u4e2a\u7a7a\u7684\u6587\u672c\u884c\u6765\u7ec8\u6b62\u62a5\u5934\u5217\u8868\u3002\u8bf7\u6c42\u884c\u7684\u5f62\u5f0f\u662f\uff1a",(0,r.kt)("inlineCode",{parentName:"p"},"method URI version"),"\uff0c\u672c\u670d\u52a1\u5668\u53ea\u652f\u6301 GET \u65b9\u6cd5"),(0,r.kt)("p",null,"\u5c06 URI \u89e3\u6790\u51fa\u6765\u540e\uff0c\u9700\u8981\u5224\u65ad\u8bf7\u6c42\u7684\u662f\u9759\u6001\u5185\u5bb9\u8fd8\u662f\u52a8\u6001\u5185\u5bb9\uff0c\u5206\u522b\u6267\u884c\u3002\u7ed9\u51fa\u51fd\u6570",(0,r.kt)("inlineCode",{parentName:"p"},"doit")),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(46598).Z,width:"1100",height:"677"})),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(2688).Z,width:"993",height:"842"})),(0,r.kt)("p",null,"\u89e3\u6790 URI \u90fd\u662f\u7ec6\u8282\u4e0a\u7684\u95ee\u9898\uff0c\u8fd9\u91cc\u4e0d\u518d\u5206\u6790"),(0,r.kt)("h3",{id:"\u63d0\u4f9b\u9759\u6001\u5185\u5bb9"},"\u63d0\u4f9b\u9759\u6001\u5185\u5bb9"),(0,r.kt)("p",null,"\u4e00\u4e2a HTTP \u54cd\u5e94\u7684\u7ec4\u6210\u662f\u8fd9\u6837\u7684\uff1a\u4e00\u4e2a\u54cd\u5e94\u884c\uff0c\u540e\u9762\u8ddf\u968f\u7740\u96f6\u4e2a\u6216\u66f4\u591a\u7684\u76f8\u5e94\u62a5\u5934\uff0c\u518d\u8ddf\u968f\u7740\u4e00\u4e2a\u7ec8\u6b62\u62a5\u5934\u7684\u7a7a\u884c\uff0c\u968f\u540e\u8ddf\u968f\u54cd\u5e94\u4e3b\u4f53\uff0c\u76f8\u5e94\u884c\u7684\u683c\u5f0f\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"version status-code status-massage"),"\u3002\u4e8e\u662f\u7ed9\u51fa\u51fd\u6570",(0,r.kt)("inlineCode",{parentName:"p"},"serve_static")),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(72977).Z,width:"1076",height:"851"})),(0,r.kt)("h3",{id:"\u63d0\u4f9b\u52a8\u6001\u5185\u5bb9"},"\u63d0\u4f9b\u52a8\u6001\u5185\u5bb9"),(0,r.kt)("p",null,"TINY \u6d3e\u751f\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u5e76\u5728\u5b50\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\u4e2d\u8fd0\u884c\u4e00\u4e2a CGI \u7a0b\u5e8f"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(55665).Z,width:"1227",height:"673"})),(0,r.kt)("h3",{id:"\u4e3b\u51fd\u6570"},"\u4e3b\u51fd\u6570"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(46898).Z,width:"1212",height:"880"})),(0,r.kt)("h2",{id:"part-1-implementing-a-sequential-web-proxy"},"Part 1: Implementing A sequential web proxy"),(0,r.kt)("p",null,"\u8981\u6c42\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5b9e\u73b0\u4e00\u4e2a\u5904\u7406 HTTP/1.0 GET \u8bf7\u6c42\u7684\u57fa\u672c\u987a\u5e8f web \u4ee3\u7406")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5982\u679c\u63a5\u6536\u5230\u4e00\u4e2a\u6d4f\u89c8\u5668\u8bf7\u6c42\u4e3a HTTP/1.1 \u7248\u672c\uff0c\u5219\u5e94\u5c06\u5b83\u4f5c\u4e3a HTTP/1.0 \u8bf7\u6c42\u8f6c\u53d1")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u8f6c\u53d1\u5408\u6cd5\u7684 HTTP \u8bf7\u6c42"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5047\u8bbe\u8bf7\u6c42\u4e3a ",(0,r.kt)("inlineCode",{parentName:"li"},"GET http://www.cmu.edu/hub/index.html HTTP/1.1")),(0,r.kt)("li",{parentName:"ul"},"\u5219\u4e3b\u673a\u540d\u4e3a ",(0,r.kt)("inlineCode",{parentName:"li"},"www.cmu.edu")),(0,r.kt)("li",{parentName:"ul"},"\u8bf7\u6c42\u7684\u9875\u9762\u4e3a ",(0,r.kt)("inlineCode",{parentName:"li"},"/hub/index.html")),(0,r.kt)("li",{parentName:"ul"},"HTTP \u8bf7\u6c42\u6bcf\u884c\u4ee5 ",(0,r.kt)("inlineCode",{parentName:"li"},"\\r\\n")," \u7ed3\u675f\uff0c\u4ee5\u4e00\u4e2a\u7a7a\u884c ",(0,r.kt)("inlineCode",{parentName:"li"},"\\r\\n")," \u7ed3\u5c3e"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u4ee3\u7406\u53d1\u9001\u7684\u8bf7\u6c42\u7684 header \u4e3a\uff1a"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Host"),": \u5982 ",(0,r.kt)("inlineCode",{parentName:"p"},"Host: www.cmu.edu"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"User-Agent"),": \u5982 ",(0,r.kt)("inlineCode",{parentName:"p"},"User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Connection"),": \u5fc5\u987b\u53d1\u9001 ",(0,r.kt)("inlineCode",{parentName:"p"},"Connection: close"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Proxy-Connection"),": \u5fc5\u987b\u53d1\u9001 ",(0,r.kt)("inlineCode",{parentName:"p"},"Proxy-Connection: close"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u8981\u5904\u7406\u8fc7\u65e9\u5173\u95ed\u7684\u8fde\u63a5\uff0c\u5373\u5fc5\u987b\u6355\u83b7 SIGPIPE \u4fe1\u53f7"))),(0,r.kt)("p",null,"\u8fd9\u90e8\u5206\u6ca1\u4ec0\u4e48\u597d\u8bf4\u7684"),(0,r.kt)("h3",{id:"\u7b49\u5f85\u5ba2\u6237\u7aef\u8fde\u63a5"},"\u7b49\u5f85\u5ba2\u6237\u7aef\u8fde\u63a5"),(0,r.kt)("p",null,"\u9996\u5148\u662f\u6211\u4eec\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"main"),"\u51fd\u6570\uff0c\u4e0d\u65ad\u7b49\u5f85\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c\u4ee3\u7801\u4e0e TINY\u670d\u52a1\u5668\u4ee3\u7801\u5b8c\u5168\u76f8\u540c\uff0c\u4e0d\u518d\u8bb2\u89e3"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},'int main(int argc, char **argv)\n{\n    int listenfd, connfd;\n    socklen_t clientlen;\n    char hostname[MAXLINE], port[MAXLINE];\n\n    struct sockaddr_storage clientaddr;\n    if (argc != 2)\n    {\n        fprintf(stderr, "usage :%s <port> \\n", argv[0]);\n        exit(1);\n    }\n    signal(SIGPIPE, sigpipe_handler);   //\u6355\u83b7SIGPIPE\u4fe1\u53f7\n    listenfd = Open_listenfd(argv[1]);\n    while (1)\n    {\n        clientlen = sizeof(clientaddr);\n        connfd = Accept(listenfd, (SA *)&clientaddr, &clientlen);\n\n        Getnameinfo((SA *)&clientaddr, clientlen, hostname, MAXLINE, port, MAXLINE, 0);\n        printf("Accepted connection from (%s %s).\\n", hostname, port);\n\n        doit(connfd);\n        //\u5173\u95ed\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u63cf\u8ff0\u7b26\n        Close(connfd);\n    }\n    return 0;\n}\n')),(0,r.kt)("h3",{id:"\u8f6c\u53d1\u4e0e\u56de\u590d"},"\u8f6c\u53d1\u4e0e\u56de\u590d"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"doit"),"\u51fd\u6570\u524d\u534a\u90e8\u5206\u4e0e TINY \u670d\u52a1\u5668\u76f8\u4f3c\uff0c\u4e0d\u540c\u7684\u662f\u5c06\u540e\u534a\u90e8\u5206\u7684\u8bf7\u6c42\u5904\u7406\u6539\u4e3a\u8f6c\u53d1\u7ed9\u670d\u52a1\u5668\uff0c\u518d\u5c06\u670d\u52a1\u5668\u7684\u56de\u590d\u56de\u590d\u7ed9\u5ba2\u6237\u7aef"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},'void doit(int connfd)\n{\n    char buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];\n    char server[MAXLINE];\n \n    rio_t rio, server_rio;\n\n    Rio_readinitb(&rio, connfd);\n    Rio_readlineb(&rio, buf, MAXLINE);\n    sscanf(buf, "%s %s %s", method, uri, version);\n\n    if (strcasecmp(method, "GET"))\n    {\n        printf("Proxy does not implement the method");\n        return;\n    }\n\n    struct Uri *uri_data = (struct Uri *)malloc(sizeof(struct Uri));\n    //\u89e3\u6790uri\n    parse_uri(uri, uri_data);\n    \n    //\u8bbe\u7f6eheader\n    build_header(server, uri_data, &rio);\n\n    //\u8fde\u63a5\u670d\u52a1\u5668\n    int serverfd = Open_clientfd(uri_data->host, uri_data->port);\n    if (serverfd < 0)\n    {\n        printf("connection failed\\n");\n        return;\n    }\n    //\u8f6c\u53d1\u7ed9\u670d\u52a1\u5668\n    Rio_readinitb(&server_rio, serverfd);\n    Rio_writen(serverfd, server, strlen(server));\n\n    size_t n;\n    //\u56de\u590d\u7ed9\u5ba2\u6237\u7aef\n    while ((n = Rio_readlineb(&server_rio, buf, MAXLINE)) != 0)\n    {\n        printf("proxy received %d bytes,then send\\n", (int)n);\n        Rio_writen(connfd, buf, n);\n    }\n    //\u5173\u95ed\u670d\u52a1\u5668\u63cf\u8ff0\u7b26\n    Close(serverfd);\n}\n')),(0,r.kt)("h3",{id:"\u89e3\u6790uri"},"\u89e3\u6790uri"),(0,r.kt)("p",null,"\u6839\u636e uri \u7ed3\u6784\u5b9a\u4e49\u4e00\u4e2a\u7ed3\u6784\u4f53\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"struct Uri\n{\n    char host[MAXLINE]; //hostname\n    char port[MAXLINE]; //\u7aef\u53e3\n    char path[MAXLINE]; //\u8def\u5f84\n};\n")),(0,r.kt)("p",null,"\u89e3\u6790\u51fd\u6570\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},'//\u89e3\u6790uri\nvoid parse_uri(char *uri, struct Uri *uri_data)\n{\n    char *hostpose = strstr(uri, "//");\n    //\u9ed8\u8ba4\u7aef\u53e3\u4e3a80\n    if (hostpose == NULL)\n    {\n        char *pathpose = strstr(uri, "/");\n        if (pathpose != NULL)\n            strcpy(uri_data->path, pathpose);\n        strcpy(uri_data->port, "80");\n        return;\n    }\n    else\n    {\n        char *portpose = strstr(hostpose + 2, ":");\n        if (portpose != NULL)\n        {\n            int tmp;\n            sscanf(portpose + 1, "%d%s", &tmp, uri_data->path);\n            sprintf(uri_data->port, "%d", tmp);\n            *portpose = \'\\0\';\n        }\n        else\n        {\n            char *pathpose = strstr(hostpose + 2, "/");\n            if (pathpose != NULL)\n            {\n                strcpy(uri_data->path, pathpose);\n                strcpy(uri_data->port, "80");\n                *pathpose = \'\\0\';\n            }\n        }\n        strcpy(uri_data->host, hostpose + 2);\n    }\n    return;\n}\n')),(0,r.kt)("h3",{id:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c"},"\u6d4b\u8bd5\u4e0e\u7ed3\u679c"),(0,r.kt)("p",null,"\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\uff0c\u8fd9\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"driver.sh"),"\u5728 wsl \u4e0a\u603b\u662f\u51fa\u95ee\u9898\uff0c\u53ea\u597d\u62ff\u51fa\u6211\u7684 vm \u865a\u62df\u673a\u6765\u8dd1\u4e86"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(49808).Z,width:"873",height:"810"})),(0,r.kt)("p",null,"40 \u5206\u5168\u90e8\u62ff\u5230\uff01"),(0,r.kt)("h2",{id:"part-2-dealing-with-multiple-concurrent-requests"},"Part 2: Dealing with multiple concurrent requests"),(0,r.kt)("p",null,"\u8bbe\u8ba1\u591a\u7ebf\u7a0b\u5e76\u53d1\u5904\u7406\u5ba2\u6237\u7aef\u8bf7\u6c42\uff0c\u8fd9\u91cc\u91c7\u7528\u9884\u7ebf\u7a0b\u5316\u7684\u6280\u672f\uff0c\u5982\u56fe\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(62038).Z,width:"1631",height:"559"})),(0,r.kt)("p",null,"\u8fd9\u662f\u4e00\u4e2a\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b\uff0c\u6211\u4eec\u56de\u987e\u4e00\u4e0b\uff1a"),(0,r.kt)("h3",{id:"\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b"},"\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u6a21\u578b"),(0,r.kt)("p",null,"\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u7ebf\u7a0b\u5171\u4eab\u4e00\u4e2a\u6709 n \u4e2a\u69fd\u7684\u4f18\u5148\u7f13\u51b2\u533a\uff0c\u751f\u4ea7\u8005\u53cd\u590d\u5730\u751f\u6210\u65b0\u7684\u9879\u76ee\uff0c\u5e76\u628a\u5b83\u4eec\u63d2\u5165\u5230\u7f13\u51b2\u533a\u4e2d\u3002\u6d88\u8d39\u8005\u7ebf\u7a0b\u4e0d\u65ad\u4ece\u7f13\u51b2\u533a\u4e2d\u53d6\u51fa\uff0c\u8fd9\u4e9b\u9879\u76ee\u7136\u540e\u4f7f\u7528\u5b83\u4eec\u3002\u56e0\u4e3a\u63d2\u5165\u548c\u53d6\u51fa\u9879\u76ee\u90fd\u6d89\u53ca\u66f4\u65b0\u5171\u4eab\u53d8\u91cf\uff0c\u6240\u4ee5\u6211\u4eec\u5fc5\u987b\u4fdd\u8bc1\u5bf9\u7f13\u51b2\u533a\u5730\u8bbf\u95ee\u662f\u4e92\u65a5\u7684\uff0c\u5e76\u8c03\u5ea6\u5bf9\u7f13\u51b2\u533a\u5730\u8bbf\u95ee\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c\u6ca1\u6709\u69fd\u4f4d\uff1a\u751f\u4ea7\u8005\u5fc5\u987b\u7b49\u5f85"),(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c\u6ca1\u6709\u9879\u76ee\uff1a\u6d88\u8d39\u8005\u5fc5\u987b\u7b49\u5f85")),(0,r.kt)("p",null,"\u5728\u9884\u7ebf\u7a0b\u5316\u7684\u670d\u52a1\u5668\u4e2d\uff0c\u5ba2\u6237\u7aef\u5c31\u662f\u751f\u4ea7\u8005\uff0c\u4e0d\u65ad\u4ea7\u751f\u8fde\u63a5\uff1bProxy \u5c31\u662f\u6d88\u8d39\u8005\uff0c\u4e0d\u65ad\u9009\u4e2d\u5ba2\u6237\u7aef\u8fde\u63a5"),(0,r.kt)("p",null,"\u4e3a\u6b64\uff0c\u5f00\u53d1\u4e00\u4e2a SBUF \u5305\u6765\u5b9e\u73b0\u8fd9\u4e2a\u7f13\u51b2\u533a\u5730\u8c03\u5ea6\u3002\u7f13\u51b2\u533a\u8bbe\u8ba1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"typedef struct {\n    int *buf;          /* Buffer array */         \n    int n;             /* Maximum number of slots */\n    int front;         /* buf[(front+1)%n] is first item */\n    int rear;          /* buf[rear%n] is last item */\n    sem_t mutex;       /* Protects accesses to buf */\n    sem_t slots;       /* Counts available slots */\n    sem_t items;       /* Counts available items */\n} sbuf_t;\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5176\u4e2d\u6709 3 \u4e2a\u4fe1\u53f7\u91cf",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"mutex \u521d\u59cb\u5316\u4e3a 1\uff0c\u4fdd\u8bc1\u5bf9\u7f13\u51b2\u533a\u7684\u8bbf\u95ee\u662f\u4e92\u65a5\u7684"),(0,r.kt)("li",{parentName:"ul"},"slots \u521d\u59cb\u5316\u4e3a n\uff0c\u8bb0\u5f55\u69fd\u4f4d"),(0,r.kt)("li",{parentName:"ul"},"items \u521d\u59cb\u5316\u4e3a 0\uff0c\u8bb0\u5f55\u9879\u76ee\u6570")))),(0,r.kt)("p",null,"\u7531\u6b64\uff0c\u8bbe\u8ba1\u5ba2\u6237\u7aef\u5411\u7f13\u51b2\u533a\u63d2\u5165\u51fd\u6570\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"void sbuf_insert(sbuf_t *sp, int item)\n{\n    P(&sp->slots);                          /* Wait for available slot */\n    P(&sp->mutex);                          /* Lock the buffer */\n    sp->buf[(++sp->rear)%(sp->n)] = item;   /* Insert the item */\n    V(&sp->mutex);                          /* Unlock the buffer */\n    V(&sp->items);                          /* Announce available item */\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u9996\u5148\u6709\u4e00\u4e2a\u5bf9 slots \u7684 P \u64cd\u4f5c\uff0c\u4fdd\u8bc1\u4e86\u5982\u679c\u69fd\u4f4d\u5df2\u6ee1\uff0c\u5219\u5ba2\u6237\u7aef\u88ab\u6302\u8d77\uff0c\u4e0d\u4f1a\u7ee7\u7eed\u5f80\u7f13\u51b2\u533a\u5199\u5165\u8bf7\u6c42"),(0,r.kt)("li",{parentName:"ul"},"\u7136\u540e\u662f\u4e00\u4e2a mutex \u7684 P \u64cd\u4f5c\uff0c\u4fdd\u8bc1\u4e86\u5bf9\u7f13\u51b2\u533a\u4e92\u65a5\u7684\u8bbf\u95ee"),(0,r.kt)("li",{parentName:"ul"},"\u7f13\u51b2\u533a\u63d2\u5165\u5b8c\u6210\u540e\uff0c\u91ca\u653e\u6240\u6709\u7684\u9501")),(0,r.kt)("p",null,"\u8bbe\u8ba1 Proxy \u4ece\u7f13\u51b2\u533a\u8bfb\u5165\u7684\u51fd\u6570\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"int sbuf_remove(sbuf_t *sp)\n{\n    int item;\n    P(&sp->items);                          /* Wait for available item */\n    P(&sp->mutex);                          /* Lock the buffer */\n    item = sp->buf[(++sp->front)%(sp->n)];  /* Remove the item */\n    V(&sp->mutex);                          /* Unlock the buffer */\n    V(&sp->slots);                          /* Announce available slot */\n    return item;\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u9996\u5148\u6709\u4e00\u4e2a\u5bf9 items \u7684 P \u64cd\u4f5c\uff0c\u4fdd\u8bc1\u4e86\u5982\u679c\u6ca1\u6709\u9879\u76ee\uff0c\u5219 Proxy \u88ab\u6302\u8d77\uff0c\u4e0d\u4f1a\u7ee7\u7eed\u5f80\u7f13\u51b2\u533a\u8bfb\u51fa\u5ba2\u6237\u7aef"),(0,r.kt)("li",{parentName:"ul"},"\u7136\u540e\u662f\u4e00\u4e2a mutex \u7684 P \u64cd\u4f5c\uff0c\u4fdd\u8bc1\u4e86\u5bf9\u7f13\u51b2\u533a\u4e92\u65a5\u7684\u8bbf\u95ee"),(0,r.kt)("li",{parentName:"ul"},"\u7f13\u51b2\u533a\u8bfb\u51fa\u5b8c\u6210\u540e\uff0c\u91ca\u653e\u6240\u6709\u7684\u9501\uff0c\u8fd4\u56de\u5176\u4e2d\u4e00\u4e2a\u5ba2\u6237\u7aef\u7684\u63cf\u8ff0\u7b26")),(0,r.kt)("h3",{id:"\u57fa\u4e8e\u9884\u7ebf\u7a0b\u5316\u7684-proxy"},"\u57fa\u4e8e\u9884\u7ebf\u7a0b\u5316\u7684 Proxy"),(0,r.kt)("p",null,"\u5927\u90e8\u5206\u4ee3\u7801\u4e0e\u7b2c 1 \u90e8\u5206\u4e00\u6837"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},'int main(int argc, char **argv)\n{\n    int listenfd, connfd;\n    socklen_t clientlen;\n    char hostname[MAXLINE], port[MAXLINE];\n\n    struct sockaddr_storage clientaddr;\n\n    pthread_t tid;\n\n    if (argc != 2)\n    {\n        fprintf(stderr, "usage :%s <port> \\n", argv[0]);\n        exit(1);\n    }\n    signal(SIGPIPE, sigpipe_handler);\n    listenfd = Open_listenfd(argv[1]);\n\n    sbuf_init(&sbuf, SBUFSIZE);\n    //\u521b\u5efa\u5de5\u4f5c\u8005\u7ebf\u7a0b\n    for(int i = 0; i < NTHREADS; i++)\n    {\n        Pthread_create(&tid, NULL, thread, NULL);\n    }\n\n    while (1)\n    {\n        clientlen = sizeof(clientaddr);\n        connfd = Accept(listenfd, (SA *)&clientaddr, &clientlen);\n        //\u5411\u7f13\u51b2\u533a\u5199\u5165\u8fd9\u4e2a\u63cf\u8ff0\u7b26\n        sbuf_insert(&sbuf, connfd);\n        Getnameinfo((SA *)&clientaddr, clientlen, hostname, MAXLINE, port, MAXLINE, 0);\n        printf("Accepted connection from (%s %s).\\n", hostname, port);\n    }\n    return 0;\n}\n')),(0,r.kt)("p",null,"\u7136\u540e\u662f\u7ebf\u7a0b\u6267\u884c\u51fd\u6570\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"void *thread(void *vargp)\n{\n    Pthread_detach(pthread_self());\n    while(1){\n    //\u4ece\u7f13\u51b2\u533a\u4e2d\u8bfb\u51fa\u63cf\u8ff0\u7b26\n    int connfd = sbuf_remove(&sbuf);\n    //\u8f6c\u53d1\n    doit(connfd);\n    //\u5173\u95ed\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u63cf\u8ff0\u7b26\n    Close(connfd);}\n}\n")),(0,r.kt)("h3",{id:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c-1"},"\u6d4b\u8bd5\u4e0e\u7ed3\u679c"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u8fd9\u91cc\u6709\u4e00\u4e2a\u5927\u5751\uff01")),(0,r.kt)("p",null,"\u6d4b\u8bd5\u7b2c 2 \u90e8\u5206\uff0c\u603b\u662f\u6709\u5982\u4e0b\u63d0\u793a\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"Timeout waiting for the server to grab the port reserved for it\n")),(0,r.kt)("p",null,"\u6211\u4e00\u76f4\u4ee5\u4e3a\u662f\u6211\u7684\u7a0b\u5e8f\u6709 bug\uff0c\u7ec6\u5fc3\u9605\u8bfb\u4e86\u597d\u591a\u904d\u3002\u540e\u6765\u67e5\u770b\u4ed6\u4eba\u535a\u5ba2\uff0c\u53d1\u73b0\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"driver.sh"),"\u6587\u4ef6\u5199\u7684\u6709\u95ee\u9898\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(87176).Z,width:"979",height:"151"})),(0,r.kt)("p",null,"\u8fd9\u4e00\u90e8\u5206\uff0c\u4f5c\u8005\u5199\u4e86\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"nop-server.py"),"\u811a\u672c\u6a21\u62df\u4e00\u4e2a\u6c38\u8fdc\u4e0d\u4f1a\u54cd\u5e94\u7684\u670d\u52a1\u5668\uff0c\u6765\u6d4b\u8bd5\u6211\u4eec Proxy \u7684\u5e76\u53d1\u6027\u80fd\u3002301 \u884c\u8fd9\u91cc\u5e94\u8be5\u6539\u4e3a\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(94944).Z,width:"992",height:"156"})),(0,r.kt)("p",null,"\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(61010).Z,width:"796",height:"293"})),(0,r.kt)("p",null,"15 \u5206\u6ee1\u5206\uff01"),(0,r.kt)("h2",{id:"part-3-caching-web-objects"},"Part 3: Caching web objects"),(0,r.kt)("p",null,"\u679c\u7136\u662f\u4e07\u7269\u7686\u53ef\u52a0\u4e00\u5c42 Cache\u3002\u5728 Proxy \u4e2d\uff0c\u5f53\u591a\u4e2a\u5ba2\u6237\u7aef\u6216\u4e00\u4e2a\u5ba2\u6237\u7aef\u591a\u6b21\u8bbf\u95ee\u540c\u4e00\u4e2a\u670d\u52a1\u7aef\u7684\u540c\u4e00\u5bf9\u8c61\u65f6\uff0cProxy \u6bcf\u6b21\u90fd\u8981\u4ece\u670d\u52a1\u7aef\u8bf7\u6c42\uff0c\u8fd9\u662f\u5f88\u8017\u8d39\u65f6\u95f4\u7684\u3002\u5982\u679c Proxy \u80fd\u628a\u8bbf\u95ee\u8fc7\u7684\u5bf9\u8c61\u5b58\u50a8\u4e0b\u6765\uff0c\u90a3\u4e48\u518d\u6b21\u9047\u5230\u540c\u6837\u7684\u8bf7\u6c42\u65f6\uff0c\u5c31\u4e0d\u9700\u8981\u518d\u8fde\u63a5\u5230\u670d\u52a1\u7aef\u4e86\uff0c\u53ef\u4ee5\u76f4\u63a5\u56de\u590d\u7ed9\u5ba2\u6237\u7aef\u3002\u800c Cache \u7684\u5927\u5c0f\u5e76\u4e0d\u662f\u65e0\u9650\u7684\uff0c\u6240\u4ee5\u5c31\u53c8\u8981\u8003\u8651\u66ff\u6362\u7b56\u7565\uff0c\u672c\u5b9e\u9a8c\u8981\u6c42\u4f7f\u7528 LRU\u3002"),(0,r.kt)("p",null,"LRU \u548c Cache \u5728 Cache Lab \u4e2d\u6709\u8be6\u7ec6\u7684\u8bb2\u8ff0\u3002\u56e0\u6b64 Cache \u7684\u5b9e\u73b0\u5728\u8fd9\u91cc\u5c31\u4e0d\u518d\u8bb2\u89e3\u4e86\uff0c\u53ef\u524d\u5f80\u67e5\u770b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://zhuanlan.zhihu.com/p/484657229"},"https://zhuanlan.zhihu.com/p/484657229")),(0,r.kt)("p",null,"\u8fd9\u91cc\u4e3b\u8981\u8bb2\u89e3\u4e00\u4e0b\u8bfb\u8005-\u5199\u8005\u6a21\u578b"),(0,r.kt)("h3",{id:"\u8bfb\u8005-\u5199\u8005\u6a21\u578b"},"\u8bfb\u8005-\u5199\u8005\u6a21\u578b"),(0,r.kt)("p",null,"\u4e00\u7ec4\u5e76\u53d1\u7684\u7ebf\u7a0b\u8981\u8bbf\u95ee\u540c\u4e00\u4e2a\u5171\u4eab\u5bf9\u8c61\u65f6\uff0c\u5c06\u53ea\u8bfb\u5bf9\u8c61\u7684\u7ebf\u7a0b\u53eb\u505a\u8bfb\u8005\uff0c\u53ea\u4fee\u6539\u5bf9\u8c61\u7684\u8fdb\u7a0b\u53eb\u505a\u5199\u8005\u3002\u5199\u8005\u5fc5\u987b\u62e5\u6709\u5bf9\u5bf9\u8c61\u7684\u72ec\u5360\u7684\u8bbf\u95ee\uff0c\u800c\u8bfb\u8005\u53ef\u4ee5\u4e0e\u5176\u5b83\u8bfb\u8005\u5171\u4eab\u5bf9\u8c61\u3002\u8be5\u6a21\u578b\u5206\u4e3a\u4e24\u7c7b\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8bfb\u4f18\u5148\uff1a\u8981\u6c42\u4e0d\u8ba9\u8bfb\u8005\u7b49\u5f85"),(0,r.kt)("li",{parentName:"ul"},"\u5199\u4f18\u5148\uff1a\u8981\u6c42\u5728\u5199\u8005\u4e4b\u540e\u5230\u8fbe\u7684\u8bfb\u8005\u5fc5\u987b\u7b49\u5f85")),(0,r.kt)("p",null,"\u5bf9\u4e8e\u8bfb\u8005\u4f18\u5148\uff0c\u53ea\u8981\u6709\u5176\u5b83\u8bfb\u8005\uff0c\u5219\u5c31\u5e94\u8ba9\u8bfb\u8005\u5148\u8bfb\uff0c\u56e0\u6b64\u8bbe\u7f6e\u4e00\u4e2a read_cnt \u8bb0\u5f55\u8bfb\u8005\u6570\u91cf\uff0c\u8fd9\u4e2a\u53d8\u91cf\u5bf9\u4e8e\u8bfb\u8005\u6765\u8bf4\u4e5f\u662f\u4e92\u65a5\u7684\uff0c\u6240\u4ee5\u8bbe\u7f6e\u4e00\u4e2a mutex \u4fe1\u53f7\u91cf\u6765\u4fdd\u62a4\uff0c\u8bfb\u7684\u8fc7\u7a0b\u4e2d\u4e0d\u5141\u8bb8\u5199\u8005\u5199\uff0c\u5199\u7684\u8fc7\u7a0b\u4e0d\u5141\u8bb8\u8bfb\u8005\u8bfb\uff0c\u6240\u4ee5\u8bbe\u7f6e w \u6765\u4fdd\u62a4\u5171\u4eab\u5bf9\u8c61"),(0,r.kt)("p",null,"\u8bfb\u4f18\u5148\u4ee3\u7801\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"int read_cnt;\nsem_t mutex, w;    //\u90fd\u521d\u59cb\u5316\u4e3a1\n\nvoid reader(void) \n{\n    while(1){\n        P(&mutex);\n        readcnt++;\n        if(readcnt==1)\n            P(&w);\n        V(&mutex);\n        \n        P(&mutex);\n        readcnt--;\n        if(readcnt==0)\n            V(&w);\n        V(&mutex);\n    }\n}\n\nvoid writer(void)\n{\n    while(1){\n        P(&w);\n        \n        ...\n        \n        V(&w)\n    }\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u53ea\u6709\u7b2c\u4e00\u4e2a\u8bfb\u8005\u5bf9 w \u52a0\u9501\uff0c\u6700\u540e\u4e00\u4e2a\u8bfb\u8005\u89e3\u9501\u3002\u56e0\u6b64\u4e00\u65e6\u6709\u4e00\u4e2a\u8bfb\u8005\u52a0\u9501\uff0c\u5199\u8005\u5c31\u65e0\u6cd5\u8bbf\u95ee\u8fd9\u4e2a\u5171\u4eab\u5bf9\u8c61\u4e86\uff0c\u800c\u5176\u5b83\u8bfb\u8005\u53ef\u4ee5\u968f\u610f\u8bbf\u95ee")),(0,r.kt)("h3",{id:"cache-\u7ed3\u6784"},"Cache \u7ed3\u6784"),(0,r.kt)("p",null,"\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u5bf9 Cache \u7684\u8bbf\u95ee\u5c31\u662f\u4e00\u4e2a\u7ecf\u5178\u7684\u8bfb\u8005-\u5199\u8005\u95ee\u9898\u3002\u6709\u7684\u7ebf\u7a0b\u8981\u4ece Cache \u4e2d\u8bfb\u51fa\uff0c\u6709\u7684\u7ebf\u7a0b\u8981\u5199\u5165 Cache\u3002\u663e\u7136\uff0c\u4e3a\u4e86 Proxy \u66f4\u52a0\u9ad8\u6548\uff0c\u8fd9\u91cc\u5e94\u8be5\u7528\u8bfb\u4f18\u5148\u7684\u6a21\u578b\u3002 "),(0,r.kt)("p",null,"\u5b9a\u4e49\u5982\u4e0b\u7684 Cache \u7ed3\u6784"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},"// Cache\u7ed3\u6784\ntypedef struct\n{\n    char obj[MAX_OBJECT_SIZE];\n    char uri[MAXLINE];\n    int LRU;\n    int isEmpty;\n\n    int read_cnt; //\u8bfb\u8005\u6570\u91cf\n    sem_t w;      //Cache\u4fe1\u53f7\u91cf\n    sem_t mutex;  //read_cnt\u4fe1\u53f7\u91cf\n\n} block;\n\ntypedef struct\n{\n    block data[MAX_CACHE];\n    int num;\n} Cache;\n")),(0,r.kt)("h3",{id:"\u4ee3\u7801"},"\u4ee3\u7801"),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"doit"),"\u51fd\u6570\u4e2d\uff0c\u5f97\u5230\u4e00\u4e2a\u8bf7\u6c42\u540e\uff0c\u5148\u6839\u636e uri \u5224\u65ad Cache \u4e2d\u662f\u5426\u5b58\u5728\u8fd9\u4e2a\u5185\u5bb9\uff0c\u5982\u679c\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u56de\u590d\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fde\u63a5\u670d\u52a1\u5668\uff0c\u56de\u590d\u7ed3\u675f\u540e\uff0c\u628a\u5185\u5bb9\u5199\u8fdb Cache"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c"},'void doit(int connfd)\n{\n    char buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];\n    char server[MAXLINE];\n\n    rio_t rio, server_rio;\n\n    char cache_tag[MAXLINE];\n    Rio_readinitb(&rio, connfd);\n    Rio_readlineb(&rio, buf, MAXLINE);\n    sscanf(buf, "%s %s %s", method, uri, version);\n    strcpy(cache_tag, uri);\n\n    if (strcasecmp(method, "GET"))\n    {\n        printf("Proxy does not implement the method");\n        return;\n    }\n\n    struct Uri *uri_data = (struct Uri *)malloc(sizeof(struct Uri));\n    //\u5224\u65aduri\u662f\u5426\u7f13\u5b58\uff0c\u82e5\u7f13\u5b58\uff0c\u76f4\u63a5\u56de\u590d\n    int i;\n    if ((i = get_Cache(cache_tag)) != -1)\n    {\n        //\u52a0\u9501\n        P(&cache.data[i].mutex);\n        cache.data[i].read_cnt++;\n        if (cache.data[i].read_cnt == 1)\n            P(&cache.data[i].w);\n        V(&cache.data[i].mutex);\n\n        Rio_writen(connfd, cache.data[i].obj, strlen(cache.data[i].obj));\n\n        P(&cache.data[i].mutex);\n        cache.data[i].read_cnt--;\n        if (cache.data[i].read_cnt == 0)\n            V(&cache.data[i].w);\n        V(&cache.data[i].mutex);\n        return;\n    }\n\n    //\u89e3\u6790uri\n    parse_uri(uri, uri_data);\n\n    //\u8bbe\u7f6eheader\n    build_header(server, uri_data, &rio);\n\n    //\u8fde\u63a5\u670d\u52a1\u5668\n    int serverfd = Open_clientfd(uri_data->host, uri_data->port);\n    if (serverfd < 0)\n    {\n        printf("connection failed\\n");\n        return;\n    }\n\n    Rio_readinitb(&server_rio, serverfd);\n    Rio_writen(serverfd, server, strlen(server));\n\n    char cache_buf[MAX_OBJECT_SIZE];\n    int size_buf = 0;\n    size_t n;\n    while ((n = Rio_readlineb(&server_rio, buf, MAXLINE)) != 0)\n    {\n        //\u6ce8\u610f\u5224\u65ad\u662f\u5426\u4f1a\u8d85\u51fa\u7f13\u5b58\u5927\u5c0f\n        size_buf += n;\n        if(size_buf < MAX_OBJECT_SIZE)\n            strcat(cache_buf, buf);\n        printf("proxy received %d bytes,then send\\n", (int)n);\n        Rio_writen(connfd, buf, n);\n    }\n    Close(serverfd);\n    \n    if(size_buf < MAX_OBJECT_SIZE){\n        write_Cache(cache_tag, cache_buf);\n    }\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8981\u6ce8\u610f\uff0c\u6bcf\u6b21\u8bfb\u5199\u7f13\u5b58\u65f6\uff0c\u90fd\u8981\u52a0\u76f8\u5e94\u7684\u9501")),(0,r.kt)("p",null,"Cache \u4ee5\u53ca LRU \u5177\u4f53\u5b9e\u73b0\u7684\u4ee3\u7801\uff0c\u8bf7\u524d\u5f80\u6211\u7684 Cache Lab \u89e3\u6790\u67e5\u770b\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8bb2\u89e3\u4e86\u3002"),(0,r.kt)("h3",{id:"\u6d4b\u8bd5\u4e0e\u7ed3\u679c-2"},"\u6d4b\u8bd5\u4e0e\u7ed3\u679c"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(47851).Z,width:"769",height:"344"})),(0,r.kt)("p",null,"\u6ee1\u5206\uff01"),(0,r.kt)("h2",{id:"firefox-\u5b9e\u6218\u6d4b\u8bd5"},"FireFox \u5b9e\u6218\u6d4b\u8bd5"),(0,r.kt)("p",null,"\u9996\u5148\u6253\u5f00 Proxy\uff0c\u76d1\u542c 15213 \u7aef\u53e3"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(7332).Z,width:"1055",height:"623"})),(0,r.kt)("p",null,"\u914d\u7f6e\u706b\u72d0\u7684\u4ee3\u7406\u8bbe\u7f6e\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(45822).Z,width:"991",height:"757"})),(0,r.kt)("p",null,"\u968f\u4fbf\u6253\u5f00\u767e\u5ea6\u8bd5\u8bd5"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(56016).Z,width:"1328",height:"697"})),(0,r.kt)("p",null,"\u4e0d\u51fa\u610f\u5916\uff0c\u6ca1\u6709\u8fde\u63a5\u6210\u529f\u3002\u67e5\u770b\u4e00\u4e0b Proxy \u6253\u5370\u7684\u4fe1\u606f"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(54199).Z,width:"1056",height:"625"})),(0,r.kt)("p",null,"\u662f\u56e0\u4e3a\u8bf7\u6c42\u7684\u90fd\u4e0d\u662f GET \u65b9\u6cd5"),(0,r.kt)("p",null,"\u90a3\u5c31\u53ea\u597d\u8bbf\u95ee\u4e00\u4e0b TINY \u670d\u52a1\u5668\u8bd5\u8bd5\u4e86\uff0c\u5148\u6253\u5f00\u670d\u52a1\u5668\uff0c\u8bbe\u7f6e\u7aef\u53e3\u4e3a 15214"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(96787).Z,width:"1055",height:"667"})),(0,r.kt)("p",null,"FireFox \u8bbf\u95ee\uff1a",(0,r.kt)("inlineCode",{parentName:"p"},"localhost: 15214")),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(37643).Z,width:"751",height:"430"})),(0,r.kt)("p",null,"\u8bbf\u95ee\u6210\u529f\u4e86\uff01\u751a\u81f3\u663e\u793a\u51fa\u4e86\u54e5\u65af\u62c9\uff01"),(0,r.kt)("p",null,"Proxy \u6253\u5370\u51fa\u4e00\u4e9b\u8f6c\u53d1\u4fe1\u606f\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(18170).Z,width:"1061",height:"670"})),(0,r.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6211\u505a\u8fd9\u4e2a\u5b9e\u9a8c\u611f\u53d7\u975e\u5e38\u75db\u82e6\u3002\u539f\u56e0\u5728\u4e8e CSAPP \u7684\u540e\u4e09\u7ae0\u8bb2\u5f97\u592a\u7b80\u7565\u4e86\uff0c\u5bf9\u4e8e\u6211\u8fd9\u79cd\u6ca1\u6709\u5b66\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u4e0e\u8ba1\u7b97\u673a\u7f51\u7edc\u7684\u4eba\u6765\u8bf4\uff0c\u5f04\u61c2\u5b83\u4eec\u662f\u5f88\u8270\u96be\u7684\u3002\u6bd4\u5982\uff0c\u4ece\u4fe1\u53f7\u91cf\u7684 P\u3001V \u64cd\u4f5c\u5230\u8bfb\u8005-\u5199\u8005\u6a21\u578b\u5c31\u82b1\u8d39\u4e86\u6211\u534a\u5929\u6765\u7406\u89e3"),(0,r.kt)("li",{parentName:"ul"},"\u5f53\u7136\uff0c\u5b8c\u6210\u5b9e\u9a8c\u4e5f\u662f\u6210\u5c31\u611f\u6ee1\u6ee1\u3002\u5c24\u5176\u662f\u6700\u540e\u6253\u5f00 FireFox\uff0c\u8fde\u63a5\u4e0a TINY \uff0c\u770b\u5230\u54e5\u65af\u62c9\u8df3\u51fa\u6765\u7684\u90a3\u4e00\u523b\uff0c\u4e00\u79cd\u65e0\u4e0e\u4f26\u6bd4\u7684\u559c\u60a6\u7531\u5185\u800c\u5916\u8ff8\u53d1\uff0c\u4e00\u5207\u8f9b\u82e6\u90fd\u503c\u5f97\u4e86\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u8fd9\u4e2a\u5b9e\u9a8c\u8fd8\u4f1a\u7ee7\u7eed\u66f4\u65b0\u7684\uff0c\u5e0c\u671b\u6709\u4e00\u5929\u80fd\u7528\u5b83\u8bbf\u95ee\u6240\u6709\u7684\u7f51\u9875"),(0,r.kt)("li",{parentName:"ul"},"\u672c\u5b9e\u9a8c\u8017\u65f6 2 \u5929\uff0c\u7ea6 16 \u5c0f\u65f6")),(0,r.kt)("h2",{id:"\u5199\u5728\u6700\u540e"},"\u5199\u5728\u6700\u540e"),(0,r.kt)("p",null,"\u8bfe\u672c\u65e9\u5df2\u5728\u4e0a\u5468\u5c31\u8bfb\u5b8c\u4e86\uff0c\u800c\u8fd9\u4e5f\u662f CSAPP \u7684\u6700\u540e\u4e00\u4e2a\u5b9e\u9a8c"),(0,r.kt)("p",null,"\u81f3\u6b64\uff0cCSAPP \u7684\u5b66\u4e60\u7b97\u662f\u544a\u4e00\u6bb5\u843d\u4e86\u3002\u53ef\u4ee5\u8bf4\uff0c CSAPP \u662f\u6211\u8ba1\u7b97\u673a\u7684\u542f\u8499\u6559\u6750\uff0c\u771f\u6b63\u4e3a\u6211\u6253\u5f00\u4e86\u8ba1\u7b97\u673a\u9886\u57df\u7684\u5927\u95e8\uff0c\u5f80\u540e\uff0c\u6211\u5c06\u4ee5\u5b83\u4e3a\u7eb2\uff0c\u5f80\u66f4\u6df1\u5904\u5b66\u4e60"),(0,r.kt)("p",null,"\u8fd8\u6709\u66f4\u6df1\u7684\u611f\u60f3\u4e0e\u603b\u7ed3\u7b49\u6709\u65f6\u95f4\u4e86\u518d\u5355\u5f00\u4e00\u7bc7\u6587\u7ae0\u5199\u5427"),(0,r.kt)("p",null,"\u6700\u540e\uff0c\u4ee5\u4faf\u6377\u8001\u5e08\u7684\u4e00\u6bb5\u8bdd\u7ed3\u675f\u6211\u8fd9\u4e09\u4e2a\u6708\u7684\u5192\u9669\u4e4b\u65c5"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u4f5c\u4e3a\u4e00\u4e2a\u597d\u7684\u5b66\u4e60\u8005\uff0c\u80cc\u666f\u4e0d\u662f\u91cd\u70b9\uff0c\u91cd\u8981\u7684\u662f\uff0c\u4f60\u662f\u5426\u5177\u5907\u6b63\u786e\u7684\u5b66\u4e60\u6001\u5ea6\uff0c\u8d77\u6b65\u56fa\u7136\u53ef\u4ee5\u4ece\u8f7b\u677e\u5c0f\u54c1\u5f00\u59cb\uff0c\u4f46\u5982\u679c\u78b0\u4e0a\u5927\u90e8\u5934\u5de8\u8457\u5c31\u9000\u907f\u4e09\u820d\u3001\u9003\u4e4b\u592d\u592d\uff0c\u9762\u5bf9\u4efb\u4f55\u6280\u672f\u53ea\u6c42\u5feb\u9910\u901f\u6210\uff0c\u5b66\u8bed\u8a00\u5374\u4ece\u6765\u4e0d\u5199\u7a0b\u5e8f\uff0c\u90a3\u5c31\u7edd\u5bf9\u6ca1\u6709\u6210\u4e3a\u9ad8\u624b\u4e43\u81f3\u4e13\u5bb6\u7684\u4e00\u5929\u3002\n\u6709\u4e9b\u4eba\u5b66\u4e60\uff0c\u81ea\u7ec3\u5c31\u4e00\u8eab\u94a2\u7b4b\u94c1\u9aa8\uff0c\u53ef\u4ee5\u5728\u70ed\u5e26\u4e1b\u6797\u4e2d\u62ab\u8346\u65a9\u68d8\uff0c\u5728\u83bd\u83bd\u8349\u539f\u4e2d\u8ffd\u5954\u9010\u5317\u3002\u6709\u4e9b\u4eba\u7684\u5b66\u4e60\uff0c\u65e2\u672a\u4e60\u60ef\u5927\u90e8\u5934\u4e66\uff0c\u4e5f\u4e3a\u4e60\u60ef\u4e25\u8c28\u683c\u8c03\uff0c\u66f4\u672a\u4e60\u60ef\u81ea\u4fee\u52e4\u5b66\uff0c\u662f\u6e29\u5ba4\u91cc\u7684\u4e00\u6735\u82b1\uff0c\u6ca1\u6709\u81ea\u7acb\u81ea\u5f3a\u7684\u672c\u94b1\u3002")))}d.isMDXComponent=!0},72977:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220412194347578-208410d0d4d71ab3383abb8d198006b3.png"},46598:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220412194849510-cdfb8acf15639fa780b637f15491a492.png"},55665:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220412195522104-6e203ce7a889735b481893ced4a8b1bd.png"},27991:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220412232840132-a36844968625d857165fa6db39e83608.png"},6284:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220412233236559-234e52313bff76b1842dff2790491349.png"},46898:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220412233611252-a9123d2c18685d2a4773277bb4e827e3.png"},2688:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413072204676-3142f5bd8b496545fa3835a74c302774.png"},49808:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413114835337-4efd96c332822cc1a931b294d7d22bba.png"},62038:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413115833749-67fbb35bca8fc9702d2c244555ebb204.png"},87176:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413134605317-7e6d8bc85761c81e2bd35a045327fd9c.png"},94944:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413135058638-ccb0ab7083db4fada6ed56336fa87273.png"},61010:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413135405874-39dac86b7b43d098deabbd3f502a1ea5.png"},47851:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413154457448-b26d6782437758d8eb55fd2acbd57372.png"},7332:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413155537122-d13b2c6a65f6d0583b2d4cb1a0f68a5f.png"},54199:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413155927747-712c0751ae57c1331b368280f8667725.png"},96787:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413160406236-91fe504d814c1d64af113bfece8a6eff.png"},37643:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413160538712-80950af43cdebd332a4774cd308254e2.png"},18170:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413160630313-fdf9603444f1375a7cec7d732bae2c30.png"},45822:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413160804023-a1c64bc1cccea59150c3e8ace9d677f2.png"},56016:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20220413160832627-928431f4cdfae538cf598d5313db4fe4.png"}}]);